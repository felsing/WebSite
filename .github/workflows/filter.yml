name: Build IPTV Playlist

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Download zubo_all.m3u
        run: |
          curl -fsSL \
          https://raw.githubusercontent.com/q1017673817/iptvz/refs/heads/main/zubo_all.m3u \
          -o zubo_all.m3u

      - name: Keep only Unicom
        run: |
          awk '
          /^#EXTINF/ { keep = ($0 ~ /è”é€š/); }
          keep { print }
          ' zubo_all.m3u > zubo_unicom.m3u

      # ðŸ‘‰ å°±æ˜¯æ”¾åœ¨è¿™é‡Œ ðŸ‘‡
      - name: Re-group channels by name
        run: |
          awk '
          /^#EXTINF/ {
              line = $0
              if (line ~ /CCTV-5/) {
                  group = "ä½“è‚²é¢‘é“"
              } else if (line ~ /CCTV-/) {
                  group = "å¤®è§†é¢‘é“"
              } else if (line ~ /å«è§†/) {
                  group = "å«è§†é¢‘é“"
              } else if (line ~ /ä½“è‚²|ç¯®çƒ|è¶³çƒ/) {
                  group = "ä½“è‚²é¢‘é“"
              } else if (line ~ /å°‘å„¿|å¡é€š|åŠ¨ç”»/) {
                  group = "å°‘å„¿é¢‘é“"
              } else {
                  group = "åœ°æ–¹é¢‘é“"
              }
              sub(/group-title="[^"]*"/, "group-title=\"" group "\"", line)
              print line
              getline
              print
              next
          }
          ' zubo_unicom.m3u > zubo_unicom_grouped.m3u

      - name: Commit result
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add zubo_unicom_grouped.m3u
          git commit -m "Update Unicom IPTV playlist (grouped)" || exit 0
          git push
