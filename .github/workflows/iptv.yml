name: Generate IPTV M3U

on:
  workflow_dispatch:  # 手动触发
  schedule:
    - cron: '*/30 * * * *'  # 每天凌晨 2 点（UTC）

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Run IPTV M3U Generator
        run: |
          set -eo pipefail

          # 配置路径为仓库中的输出文件（根据需要修改）
          SOURCE_BRTV="https://raw.githubusercontent.com/0047ol/BRTV-Live-M3U8/main/BRTV.m3u"
          SOURCE_IPTV="https://raw.githubusercontent.com/govan10/TV-list/refs/heads/main/%E5%A4%A9%E6%B4%A5%E8%81%94%E9%80%9A%E5%85%AC%E7%BD%91.m3u"
          OUTPUT_FILE="output/iptv.m3u"

          # 删除旧文件
          rm -f "$OUTPUT_FILE"

          # 路径验证函数
          validate_path() {
              local dir=$(dirname "$1")
              if [ ! -d "$dir" ]; then
                  echo "正在创建目录：$dir"
                  mkdir -p "$dir" || {
                      echo "错误：无法创建目录 $dir" >&2
                      return 1
                  }
              fi
              if [ ! -w "$dir" ]; then
                  echo "错误：对目录 $dir 没有写入权限" >&2
                  return 2
              fi
          }

          # 主流程
          echo "=== 开始执行 M3U 合并任务 ==="
          echo "验证输出路径: $OUTPUT_FILE"
          validate_path "$OUTPUT_FILE" || exit 1

          temp_dir=$(mktemp -d)
          trap 'rm -rf "$temp_dir"' EXIT
          echo "创建临时目录: $temp_dir"

          echo "正在下载源文件..."
          curl -sSLf "$SOURCE_BRTV" -o "$temp_dir/brtv.m3u"
          curl -sSLf "$SOURCE_IPTV" -o "$temp_dir/original.m3u"
          echo "下载完成，文件大小:"
          du -sh "$temp_dir"/*

          echo "处理北京台格式..."
          sed -E '
              s/#EXTINF:(-1) tvg-name="([^"]+)",(.*)/#EXTINF: -1 tvg-id="\2" tvg-name="\2" tvg-logo="https:\/\/live.fanmingming.cn\/tv\/\2.png" group-title="北京",\3/
          ' "$temp_dir/brtv.m3u" > "$temp_dir/processed_brtv.m3u"

          echo "合并文件中..."
          {
              grep -vP 'group-title="北京"' "$temp_dir/original.m3u"
              cat "$temp_dir/processed_brtv.m3u"
          } | awk '
          BEGIN { RS=""; FS="\n"; OFS="\n" }
          /^#EXTM3U/ {
              if (!header++) print $0
              next
          }
          /^#EXTINF/ {
              key = $0
              sub(".*tvg-id=\"", "", key)
              sub("\".*", "", key)
              if (!seen[key]++) {
                  print $0
                  getline; print $0
              }
              next
          }
          { print }' > "$OUTPUT_FILE"

          echo "合并完成！结果如下："
          echo "文件路径: $OUTPUT_FILE"
          echo "文件大小: $(du -h "$OUTPUT_FILE" | cut -f1)"
          echo "频道总数: $(grep -c '^#EXTINF' "$OUTPUT_FILE")"
          echo "北京频道数: $(grep -c 'group-title=\"北京\"' "$OUTPUT_FILE")"

      - name: Commit and Push Changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add output/iptv.m3u
          git commit -m "自动更新 IPTV 列表 $(date +'%Y-%m-%d %H:%M:%S')" || echo "无变化可提交"
          git push
