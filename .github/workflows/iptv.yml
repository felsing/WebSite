name: Auto Update IPTV

on:
  workflow_dispatch:
  schedule:
    - cron: '0,30 * * * *'

env:
  TZ: Asia/Shanghai

jobs:
  merge-and-update:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        persist-credentials: true
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup environment
      run: echo "UPDATE_TIME=$(date +'%Y-%m-%d %H:%M:%S CST')" >> $GITHUB_ENV

    - name: Process IPTV sources
      run: |
        # 清理旧文件
        rm -f *.m3u

        # 下载源文件
        wget -q https://raw.githubusercontent.com/0047ol/BRTV-Live-M3U8/main/BRTV.m3u
        wget -q https://raw.githubusercontent.com/govan10/TV-list/refs/heads/main/%E5%A4%A9%E6%B4%A5%E8%81%94%E9%80%9A%E5%85%AC%E7%BD%91.m3u

        # 处理北京台
        sed -n '/北京/,+1p' BRTV.m3u | sed -E '
            s|#EXTINF:(-1) tvg-name="([^"]+)",(.*)|#EXTINF:\1 tvg-id="\2" tvg-name="\2" tvg-logo="https://live.fanmingming.cn/tv/\2.png" group-title="北京",\3|
        ' > beijing.m3u

        # 处理原始文件（保留非北京分组）
        sed '/group-title="北京"/,+1d' iptv.m3u > original_clean.m3u

        # 合并文件（确保顺序）
        echo "#EXTM3U" > combined.m3u
        cat beijing.m3u original_clean.m3u >> combined.m3u

        # 去重处理（关键修复）
        awk '
        BEGIN { RS=""; FS="\n"; OFS="\n" }
        /^#EXTINF/ {
            key = $0
            sub(".*tvg-id=\"", "", key)
            sub("\".*", "", key)
            if (!seen[key]++) {
                print $0
                getline; print $0
            }
            next
        }
        { print }
        ' combined.m3u > iptv.m3u

        # 最终清理
        sed -i '/^$/d' iptv.m3u
        rm -f BRTV.m3u iptv.m3u beijing.m3u original_clean.m3u combined.m3u  # 清理所有中间文件
        echo "更新时间：${UPDATE_TIME}" > README.md

    - name: Commit changes
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git add .
        if git diff-index --quiet HEAD --; then
          echo "No changes"
        else
          git commit -m "自动更新: ${UPDATE_TIME}"
          git push origin HEAD:main
        fi
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
